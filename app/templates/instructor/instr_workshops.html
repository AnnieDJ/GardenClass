{% extends 'instructor/instr_dashboard.html' %}

{% block content %}

<!-- Link Bootstrap CSS for styling -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<!-- Include jQuery for handling JavaScript actions -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

<!-- Breadcrumb Navigation -->
<section class="py-3 py-md-4 py-xl-5 bg-light">
  <div class="container">
    <div class="row">
      <div class="col-12">
        <h1 class="h4">Workshop Management</h1>
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb m-0 fs-7">
            <li class="breadcrumb-item"><a class="link-primary text-decoration-none" href="{{ url_for('instructor_dashboard') }}">Home</a></li>
            <li class="breadcrumb-item">Workshops</li>
            <li class="breadcrumb-item active" aria-current="page">View All</li>
          </ol>
        </nav>
      </div>
    </div>
  </div>
</section>

<div class="container py-4">
  <!-- Workshops List -->
  <div class="row">
    {% for workshop in workshops %}
    <div class="col-md-4 mb-4">
      <div class="card">
        {% if workshop.workshop_image %}
        <img src="{{ url_for('static', filename=workshop.workshop_image) }}" alt="Workshop Image" class="card-img-top" style="height: 200px; width: 100%; object-fit: cover;">
        {% endif %}
        <div class="card-body">
          <h5 class="card-title">{{ workshop.title }}</h5>
          <p class="card-text"><strong>Instructor:</strong> {{ workshop.first_name }} {{ workshop.last_name }}</p>
          <p class="card-text"><strong>Date:</strong> {{ workshop.date }}</p>
          <p class="card-text"><strong>Start Time:</strong> {{ workshop.start_time }}</p>
          <p class="card-text"><strong>End Time:</strong> {{ workshop.end_time }}</p>
          <p class="card-text"><strong>Capacity:</strong> {{ workshop.capacity }}</p>
          <p class="card-text"><strong>Price:</strong> ${{ workshop.price }}</p>
          <button class="btn btn-warning edit-workshop-btn" data-workshop-id="{{ workshop.workshop_id }}">Edit</button>
          <button class="btn btn-danger delete-workshop-btn" data-workshop-id="{{ workshop.workshop_id }}">Delete</button>
        </div>
      </div>
    </div>
    {% else %}
    <div class="col">
      <p>No workshops found.</p>
    </div>
    {% endfor %}
  </div>
</div>


<!-- Edit Workshop Modal -->
<div id="editWorkshopModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="editWorkshopModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editWorkshopModalLabel">Edit Workshop</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="editWorkshopForm">
          <input type="hidden" id="editWorkshopID" name="workshop_id">
          <div class="form-group mb-3">
            <label for="editTitle">Title</label>
            <input type="text" class="form-control" id="editTitle" name="title" required>
          </div>
          <div class="form-group mb-3">
            <label for="editDate">Date</label>
            <input type="date" class="form-control" id="editDate" name="date" required>
          </div>
          <div class="form-group mb-3">
            <label for="editStartTime">Start Time</label>
            <input type="time" class="form-control" id="editStartTime" name="start_time" required>
          </div>
          <div class="form-group mb-3">
            <label for="editEndTime">End Time</label>
            <input type="time" class="form-control" id="editEndTime" name="end_time" required>
          </div>
          <div class="form-group mb-3">
            <label for="editCapacity">Capacity</label>
            <input type="number" class="form-control" id="editCapacity" name="capacity" min="1" required>
          </div>
          <div class="form-group mb-3">
            <label for="editPrice">Price</label>
            <input type="number" class="form-control" id="editPrice" name="price" step="0.01" required>
          </div>
          <div class="form-group mb-3">
            <label for="editLocation">Location</label>
            <select class="form-control" id="editLocation" name="location_id" required>
              <!-- Options will be dynamically loaded -->
            </select>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="submit" class="btn btn-primary" form="editWorkshopForm">Save Changes</button>
      </div>
    </div>
  </div>
</div>






<script>
$(document).ready(function() {
  // Fetch locations to populate the dropdowns
  function fetchLocations(selectedId) {
    $.get('/api/locations', function(data) {
      var locationSelect = $('#editLocation');
      locationSelect.empty();
      data.forEach(function(location) {
        var isSelected = location.id === selectedId;
        locationSelect.append(new Option(location.name, location.id, isSelected, isSelected));
      });
    });
  }

  // Event handler for opening the edit modal
  $('.edit-workshop-btn').click(function() {
    var workshopId = $(this).data('workshop-id');
    // Fetch workshop data from the server
    $.getJSON('/instructor/edit_workshop/' + workshopId, function(data) {
      if (data) {
        $('#editWorkshopID').val(data.workshop_id);
        $('#editTitle').val(data.title);
        $('#editDate').val(data.date);
        $('#editStartTime').val(data.start_time);
        $('#editEndTime').val(data.end_time);
        $('#editCapacity').val(data.capacity);
        $('#editPrice').val(data.price);
        fetchLocations(data.location_id); // Call to populate locations
        // Show the modal
        $('#editWorkshopModal').modal('show');
      }
    });
  });

  // Form submission to update the workshop
  $('#editWorkshopForm').on('submit', function(e) {
    e.preventDefault();  // Prevent the default form submission
    var formData = $(this).serialize();
    var workshopId = $('#editWorkshopID').val();

    $.ajax({
      type: 'POST',
      url: '/instructor/update_workshop/' + workshopId,
      data: formData,
      success: function(response) {
        if (response.success) {
          alert('Workshop updated successfully!');
          $('#editWorkshopModal').modal('hide');
          location.reload();  // Reload the page to reflect the changes
        } else {
          alert('Failed to update workshop: ' + response.message);
        }
      },
      error: function() {
        alert('Error updating workshop. Please try again.');
      }
    });
  });
});

</script>

{% endblock %}
